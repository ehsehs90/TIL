## 19.10.30(수) : Django Model (ORM)

- 장고MTV 패턴
  - Model
    - 특정한 데이터의 구조(모양)에 대한 정보를 가지고 있다 
      - (->데이터의 모양을 정의하는 곳)
    - 하나의 모델 클래스는 실제 DB에는 하나의 테이블로 매핑된다
    - 컬럼에 대한 정보, 해당 데이터에 대한 정보를 정의하는 곳
  - Template
- View
  
- Model 로직
  -   하나하나 모델에 대한 정보는 Class로 표현된다
  -   데이터베이스 컬럼(열) 과 어떠한 타입으로 정의할 것인지에 대한 정보를 `django.db.models`라는 곳에서 상속받아서 정의한다
  - **모든 필드들은 NOT NULL 조건**이 붙는다
  - 각각의 클래스 변수는 데이터베이스 필드를 나타낸다

### 1.1Migration

- 정의한 Model을 데이터베이스에 반영
- Python 코드만 작성하면 SQL 문을 알아서 작성해준다.



 - `makemigrations`
    - 실제 데이터베이스 테이블을 만들기 전에 설계도를 그려보는 작업	
      	- Python 코드로 데이터베이스 설계도를 작성한다
   - migrations폴더에서 확인할 수 있다 (`0001_initial.py`,...)
   
- `sqlmigrate`
  
  - 데이터베이스에 실제로 반영하기 전에 **설계한 Python 코드가 SQL문으로 바뀐 모습을 확인**해볼수 있다.
  
- `showmigrations`
  
  - migration 설계도를 작성했는데, 이 **설계도가 실제 DB 에 반영되었는지 여부**를 확인
  
- `migrate`
  - `makemigrations`로 만든 설**계도를 실제 데이터베이스(sqlite3)에 반영**한다
  - 모델의변경사항과 데이터베이스 스키마를 동기화한다
  

  
  ###### Migration 파일(=설계도) 생성
  
  ```shell
  $ python manage.py makemigrations
  ```
  
  - migrations폴더에 `0001_initial.py` 파일이 생성된다.
  
    - 0001_initial.py
  
      ```python
      # Generated by Django 2.2.6 on 2019-10-30 00:41
      from django.db import migrations, models
      
      class Migration(migrations.Migration):
      
          initial = True
      
          dependencies = [
          ]
      
          operations = [
              migrations.CreateModel(
                  name='Article',
                  fields=[
                      ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                      ('title', models.CharField(max_length=30)),
                      ('content', models.TextField()),
                      ('created_at', models.DateTimeField(auto_now_add=True)),
                  ],           
              ),
          ]
      ```
  
  - 설계한 Python 코드를 SQL문으로 확인하기
  
    - sqlmigrate
  
      ```shell 
      $ python manage.py sqlmigrate articles 0001
      ```
  
  - migration 설계도가 실제 DB에 반영되었는지 확인하기
  
    - showmigrations
  
      ```shell
      $ python manage.py showmigrations
      ```
  
      - migrate된 것은 [X]표시 안된것은 [  ] 표시
  
  - 설계도를 실제 DB에 반영하기
  
    ```shell
    $ python manage.py migrate
    ```



- 속성이 바뀌면 설계도의 위의 과정을 다시한다

    - 데이터베이스 모델링

        - Model 정의

            - `models.py`

                ```python
                #객체 표시 형식 수정
                from django.db import models
                
                class Article(models.Model):
                    title = models.CharField(max_length=40)
                    content = models.TextField()
                    created_at = models.DateTimeField(auto_now_add=True)
                    updated_at = models.DateTimeField(auto_now=True)
                    
                    def __str__(self):
                        return f'[{self.pk}]:{self.title}'
                
                ```

    - 새로운 설계도 만들기

    ```shell
    $ python manage.py makemigrations
    ```

    - 새로 작성한 설계도 반영하기

    ```shell
    $ python manage.py migrate
    ```

    - 새로 작성한 설계도 반영 확인하기

    ```shell
    $ python manage.py showmigrations
    ```

######  객체를 표시하는 형식 Customizing

- 객체를 표시하는 형식을 사용자 맞춤형으로 커스터마이징 가능하다
     - 상단의 `models.py` 를 확인하면 f 쿼리스트링으로 Customizing 한 코드를 확인할 수 있다. 

```python
# 객체를 표시하는 형식 Customizing
def__str__(self): 
    return f'[{self.pk}]:{self.title}'
```

​		- 이는 ipython shell 에서 확인 가능하다

```python
In[1] python manage.py python_shell
In[2] from articles.models import Article

In[3]: Article.objects.all()
out[3]: <QuerySet [<Article:[1]:first><Article:[2]:second>]>
```

###### sqlite3 설치 (DB에 반영된것 확인)

1. `ctrl + shift + p`를 눌러 sqlite 데이터 베이스를 Open할 프로젝트를 선택한다.( Open Database 클릭 )

2. SQLite : 작업중인 프로젝트를 선택한다(클릭)

3. `sqlite explorer` 메뉴 탭이 생성된다

   ​	`sqlite explorer` 메뉴를 열어 재생버튼을 누르면, Models를 토대로 생성된 데이터베이스를 확인할 수 있다



###### ipython (밑에 있음)

- python 개발을 도와주는 interactive 한 쉘

- ipython 설치

  ```shell
  $ pip install ipython
  ```

  - 설치 확인은 $ pip list 로 확인 가능하다.

- ipython 사용법

  ```shell
  $python manage.py shell
  ```

  - Articles 모델을 가져온다 

    ```python
    from articles.models import Article
    ```

    

## 2. ORM_CRUD

- ORM을 리턴되는 형식

  - QuerySet : 다수의 객체가 담김(Python List 다루는 것과 비슷)
  - Query : 단일객체

- `모델명.Objects.명령`

  - `objects` : 모델 클래스 정보를 토대로 실제 데이터베이스에 쿼리(SQL)를 날려서 데이터베이스와 의사소통 하는 통역사(매니저) 역할

- **우리가 ORM 을 사용하는 이유?**

  - SQL문에 종속되지 않고 데이터를 객체 형태로 다루기 위해(프로그래밍언어만 알아도 DB를 다룰 수 있음)
    
### 2.1  Create

###### CREATE

- 객체를 생성하는 방법은 세가지가 있다.

  - 1. 기본 생성자를 이용해, 각 컬럼마다 데이터를 지정한다
    2.  생성자를 이용해 인자로 컬럼의 데이터를 지정한다
    3.  ORM 의 create() 함수 이용

-  첫번째 방법

  - 객체를 생성하고, 객체의 컬럼 하나 하나에 데이터를 입력한다

  - save() 를 하기 전에는 DB에 반영되지 않는다.

    - [인스턴스].save() : 데이터 베이스에 저장

      ```python
      article = Article()
      article.title = 'first'
      article.content = 'django'
      
      article.title
      out[]='first'
      
      article.content
      out[]='django'
      ----------------여기서 Article.objects.all() 하면 
      쿼리셋에 아무것도 리턴되지 않는다 (아직 save를 안함)
      article.save()
      ----------------여기서 Article.objects.all() 하면
      쿼리셋에 데이터가 담겨온다
      
      ```
  
- 두번째 방법

  - 함수에서 키워드 인자를 넘겨주는 방식으로 생성할 수 있다
  - save()를 하기 전에는 DB에 반영되지 않는다

  ```python
  article =Article(title='second',content='python')
  article.save()
  ```

  

- 세번째 방법

  - Query Set 객체 생성과 DB 저장을 한번에 해결할 수 있다
    - create() : 데이터베이스에 바로 저장 및 반영된다.

```python
Article.objects.create(title='thrid',content='java')

```

- 유효성 검사
  - 기본적으로 `NOT Null` 조건이 붙는다
  - 유효성 검사로 활용 가능

```python
article.full_clean()
```



### ** C : 한번에 정리했어요 **

  ```sqlite
  #첫번째 방법
  article = Article()
  article.title =''
  article.content =''
  article.save()
  
  
  #두번째 방법 : 함수에서 키워드 인자 넘겨주는 방식
  article = Article (title='',content='')
  article.save()
  
  
  #세번째 방법  : 쿼리셋 객체 생성과 DB 저장을 한번에 해결
  Article.objects.create(title='sasa',content='sasa')
  ```

  ```sqlite
  #유효성 검증
  article.full_clean()
  ```

  

### 2.2 Read

- 데이터베이스에서 데이터를 조회하는 여러가지 방법이 있다

- filter(), get, order_by(), type() ...

  ​	python list와 비슷한 Query Set을 return 한다.

##### all()

  - 모든 데이터를 Query Set으로 리턴한다

```python
In [1]: Article
Out[1]: articles.models.Article

In [2]: articles = Article.objects.all()

In [3]: articles
Out[3]: <QuerySet [<Article: [1] : first>, <Article: [3번글] : third | java>, <Article: [4] : first>]>
```



##### filter()

 - query Set 으로 return한다
   	- 실습을 위해 'first'를 하나 더 추가했다

```ptrhon
n [6]: articles = Article.objects.filter(title='first')

In [7]: articles
Out[7]: <QuerySet [<Article: [1] : first>]>

In [8]: Article.objects.create(title='first', content='gogogo')
Out[8]: <Article: [4] : first>

In [9]: articles = Article.objects.filter(title='first')

In [10]: articles
Out[10]: <QuerySet [<Article: [1] : first>, <Article: [2] : second>, <Article: [3] : third>, <Article: [4] : first>]>
```

- 단 , 하나의 값을 filter 하는 경우에는 Query 를 return 한다
  - first() : 첫번째 데이터를 return 한다

```python
In [11]: articles = Article.objects.filter(title='first').first()

In [12]: articles
Out[12]: <Article: [1] : first>
```

- filter의 특정 조건 설정

- 결과 값이 여러 개일 수 있기 때문에 Query Set을 return 한다.

  - pk값으로 filter()

    ```python
    In [14]: Article.objects.filter(pk=10)
    Out[14]: <QuerySet []>
    
    In [15]: Article.objects.filter(pk=1)
    Out[15]: <QuerySet [<Article: [1] : first>]>
    ```

  - 특정 문자열로 filter() - `title__contain`

    ```python
    In [21]: articles = Article.objects.filter(title__contains='fir')
    
    In [22]: articles
    Out[22]: <QuerySet [<Article: [1] : first>, <Article: [4] : first>]>
    ```

  - 시작하는 단어로 filter() - `title__startswith`

    ```python
    In [23]: articles = Article.objects.filter(title__startswith='first')
    
    In [24]: articles
    Out[24]: <QuerySet [<Article: [1] : first>, <Article: [4] : first>]>
    
    In [25]: articles = Article.objects.filter(title__startswith='f')
    
    In [26]: articles
    Out[26]: <QuerySet [<Article: [1] : first>, <Article: [4] : first>]>
    ```

  - 끝나는 단어로 filter() - `title__endswith`

    ```python
    In [27]: articles = Article.objects.filter(title__endswith='d')
    
    In [28]: articles
    Out[28]: <QuerySet [<Article: [2] : second>, <Article: [3] : third>]>
    ```

##### get()

- 반드시 filter를 사용한다
  - 복수형을 return하는 에러를 뿜는다



##### order_by()

- 정렬
  -  `-`  : 내림차순

```python
In [16]: Article.objects.order_by('pk')
Out[16]: <QuerySet [<Article: [1] : first>, <Article: [2] : second>, <Article: [3] : third>, <Article: [4] : first>]>

In [17]: Article.objects.order_by('-pk')
Out[17]: <QuerySet [<Article: [4] : first>, <Article: [3] : third>, <Article: [2] : second>, <Article: [1] : first>]>
```

##### Type 확인

- 각 명령어에 따라 return 되는 데이터 Type이 다르다

  - Query Set
  - Query

  ```python
  In [19]: type(Article.objects.order_by('-pk'))
  Out[19]: django.db.models.query.QuerySet
  
  In [20]: type(Article.objects.get(pk=1))
  Out[20]: articles.models.Article
  ```

##### Query String 을 list로 다루기

	- list처럼 사용할 수 있다

```python
In [18]: Article.objects.all()[1:3]
Out[18]: <QuerySet [<Article: [2] : second>, <Article: [3] : third>]>

```



  ### ** R 한번에 정리했어요 **

```sqlite
# (파이썬 리스트와 비슷한) QuerySet 리턴
articles1 = Article.ojbects.all()
articles2 =Article.objects.filter()


#필터기능
##실습을 위해 'first' 를 하나 더 추가했다.
Article.objects.filter(title='first')
Article.objects.filter(pk=100)
## 단, 하나의 값을 filter 하는 경우는 Query를 return한다.
Article.objects.filter(='first').first()

#정렬기능 
Article.objects.all()
articles = Article.objects.order_by('-pk')   #내림차순
articles

Article.objects.all()
articles = Article.objects.order_by('pk')    #오름차순
articles

#쿼리셋 리턴을 list 처럼 사용할 수 있다
articles = Art
```



### 2.3 Update

###### UPDATE

- get() 을 이용해 데이터의 값을 수정한다
- sqlite에 수정한데이터를 반영하기 위해 **반드시 save()**
  - update

```sqlite
# 수정할 인스턴스 가져오기
In [29]: article = Article.objects.get(pk=2)

In [30]: article
Out[30]: <Article: [2] : second>

# 인스턴스의 값을 수정하기
In [31]: article.title = 'update_second'

# 데이터 베이스에 반영하기
In [32]: article.save()
```

### 2.4 Delete

###### DELETE

- get()을 이용해 데이터를 삭제한다
- save() 를 하지 않아도 자동으로 sqlite에 반영이 된다
  - delete

```bash
# 삭제할 인스턴스 가져오기
In [33]: article = Article.objects.get(pk=2)

In [34]: article
Out[34]: <Article: [2] : update_second>

# 삭제하기
In [35]: article.delete()
Out[35]: (1, {'articles.Article': 1})
```

  - delete는 자동으로 sqlite에 반영이 된다

    그러므로 save()를 하지 않는다.

    그냥 save()하면 다음 객체 생성 시 문제 발생



### 2.5 Django_extensions

기본 Django Shell은 직접 모델을 import 해주어야 하는 불편함이 있었지만

`shell_plus` 는 필요한 모델을 자동으로 import 해주기 때문에 편리하다.

- 설치하기

``` bash
$ pip install  django-extensions
```

- 앱 등록하기

```python
#settings.py
INSTALLED_APPS =[
    ...
    'django_extensions',
    ...
]
```

- shell 실행하기

```bash
$ python manage.py shell_plus
```

```python
# Shell Plus Model Imports
from articles.models import Article
...
Ipython 7.9.0 -- An enhanced Interactive Python. Type '?' for help.
```

## 2.6 관리자 생성

###### 데이터가 정상적으로 저장됐는지 확인하기 위해 admin 페이지로 들어가보자

- admin 계정을 생성한다

```shell
$ python manage.py createsuperuser
```

- 서버를 실행하고 `http://[로컬주소]/admin` 로 진입한다

- 관리자 폼 - 커스터마이징 가능

